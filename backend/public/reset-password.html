<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reset Password Â· Focus Tracker</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    /* Tokens â€” theme applied via body classes (same as blocked.html) */
    :root {
      --bg:#f5f3ef; --bg-card:#fdfcfa; --bg-raised:#ffffff;
      --bg-subtle:#ede9e3; --bg-sunken:#e8e4de;
      --text:#1c1917; --text-2:#57534e; --text-3:#a8a29e;
      --border:#e0dbd4;
      --sh-lg:0 24px 72px rgba(28,25,23,.13);
      --sh-md:0 8px 28px rgba(28,25,23,.09);
      --sh-sm:0 2px 8px rgba(28,25,23,.06);
      --acc:#4f46e5; --acc-2:#4338ca;
      --acc-soft:rgba(79,70,229,.09);
      --acc-grad:linear-gradient(135deg,#4f46e5 0%,#7c3aed 100%);
      --ok:#16a34a; --ok-soft:rgba(22,163,74,.1);
      --err:#dc2626; --err-soft:rgba(220,38,38,.1);
    }
    body.dark {
      --bg:#111210; --bg-card:#18191a; --bg-raised:#1f2022;
      --bg-subtle:#25272a; --bg-sunken:#0e0f0f;
      --text:#f2ede8; --text-2:#9c9490; --text-3:#5c5650;
      --border:#2a2c2e;
      --sh-lg:0 24px 72px rgba(0,0,0,.7);
      --sh-md:0 8px 28px rgba(0,0,0,.5);
      --sh-sm:0 2px 8px rgba(0,0,0,.4);
    }
    body.acc-blue   {--acc:#2563eb;--acc-2:#1d4ed8;--acc-soft:rgba(37,99,235,.09);--acc-grad:linear-gradient(135deg,#2563eb,#1d4ed8)}
    body.acc-green  {--acc:#16a34a;--acc-2:#15803d;--acc-soft:rgba(22,163,74,.09);--acc-grad:linear-gradient(135deg,#16a34a,#15803d)}
    body.acc-purple {--acc:#7c3aed;--acc-2:#6d28d9;--acc-soft:rgba(124,58,237,.09);--acc-grad:linear-gradient(135deg,#7c3aed,#6d28d9)}
    body.acc-red    {--acc:#dc2626;--acc-2:#b91c1c;--acc-soft:rgba(220,38,38,.09);--acc-grad:linear-gradient(135deg,#dc2626,#b91c1c)}
    body.acc-orange {--acc:#ea580c;--acc-2:#c2410c;--acc-soft:rgba(234,88,12,.09);--acc-grad:linear-gradient(135deg,#ea580c,#c2410c)}
    body.acc-indigo {--acc:#4f46e5;--acc-2:#4338ca;--acc-soft:rgba(79,70,229,.09);--acc-grad:linear-gradient(135deg,#4f46e5,#7c3aed)}

    body {
      font-family:'Segoe UI',system-ui,-apple-system,sans-serif;
      background:var(--bg); min-height:100vh;
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      padding:24px; color:var(--text);
      position:relative; overflow-x:hidden;
      -webkit-font-smoothing:antialiased;
      transition:background .2s,color .2s;
    }

    .blob{position:fixed;border-radius:50%;pointer-events:none;filter:blur(90px);z-index:0;background:var(--acc-soft);}
    .blob-1{width:600px;height:600px;top:-250px;right:-200px;animation:drift 14s ease-in-out infinite;}
    .blob-2{width:440px;height:440px;bottom:-200px;left:-150px;animation:drift 18s ease-in-out infinite;animation-delay:-8s;}
    @keyframes drift{0%,100%{transform:scale(1)}50%{transform:scale(1.07) translate(16px,-16px)}}

    /* â”€â”€ Card â”€â”€ */
    .card{
      position:relative;z-index:1;
      background:var(--bg-card);border:1px solid var(--border);
      border-radius:24px;padding:40px 36px 36px;
      width:100%;max-width:420px;
      box-shadow:var(--sh-lg);
      animation:slide-up .44s cubic-bezier(.22,.68,0,1.1) both;
    }
    @keyframes slide-up{from{opacity:0;transform:translateY(26px) scale(.96)}to{opacity:1;transform:none}}
    .card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--acc-grad);border-radius:24px 24px 0 0;}

    /* â”€â”€ Brand â”€â”€ */
    .brand{display:flex;align-items:center;gap:12px;margin-bottom:28px;}
    .brand-icon{width:42px;height:42px;border-radius:12px;background:var(--acc-grad);display:flex;align-items:center;justify-content:center;font-size:19px;box-shadow:0 4px 16px rgba(0,0,0,.12),0 0 0 4px var(--acc-soft);flex-shrink:0;}
    .brand-name{font-family:Georgia,'Times New Roman',serif;font-size:18px;font-weight:400;font-style:italic;color:var(--text);}
    .brand-name strong{font-style:normal;background:var(--acc-grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
    .brand-sub{font-size:12px;color:var(--text-3);margin-top:1px;}

    /* â”€â”€ Screens â”€â”€ */
    .screen{display:none;}
    .screen.active{display:block;animation:fade-in .22s ease both;}
    @keyframes fade-in{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

    /* â”€â”€ Headings â”€â”€ */
    .ttl{font-family:Georgia,'Times New Roman',serif;font-size:22px;font-weight:400;font-style:italic;color:var(--text);margin-bottom:6px;line-height:1.25;}
    .ttl strong{font-style:normal;background:var(--acc-grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
    .desc{font-size:13.5px;color:var(--text-2);line-height:1.6;margin-bottom:22px;}
    .desc .em{font-family:'Courier New',monospace;font-size:12px;background:var(--acc-soft);color:var(--acc);padding:2px 7px;border-radius:5px;display:inline-block;margin-top:3px;}

    /* â”€â”€ Inputs â”€â”€ */
    .field{margin-bottom:14px;}
    .field label{display:block;font-size:11px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--text-3);margin-bottom:7px;}
    .field input{
      width:100%;padding:12px 14px;
      border:1.5px solid var(--border);border-radius:9px;
      background:var(--bg-subtle);color:var(--text);
      font-size:15px;font-family:inherit;outline:none;
      transition:border-color .15s,background .15s,box-shadow .15s;
    }
    .field input:focus{border-color:var(--acc);background:var(--bg-raised);box-shadow:0 0 0 3px var(--acc-soft);}
    .field input.err-inp{border-color:var(--err);}
    .field input.err-inp:focus{box-shadow:0 0 0 3px var(--err-soft);}
    .pw-wrap{position:relative;}
    .pw-wrap input{padding-right:42px;}
    .eye-btn{position:absolute;right:11px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text-3);cursor:pointer;padding:3px;font-size:15px;transition:color .15s;}
    .eye-btn:hover{color:var(--text-2);}

    /* Strength bar */
    .strength-wrap{margin-top:7px;}
    .bar-track{height:3px;background:var(--border);border-radius:99px;overflow:hidden;margin-bottom:4px;}
    .bar-fill{height:100%;border-radius:99px;width:0;transition:width .35s,background .35s;}
    .strength-hint{font-size:11px;color:var(--text-3);}

    /* â”€â”€ Alert â”€â”€ */
    .alert{padding:11px 13px;border-radius:9px;font-size:13px;line-height:1.5;margin-bottom:16px;display:none;}
    .alert.show{display:block;}
    .alert.err{background:var(--err-soft);color:var(--err);border:1px solid rgba(220,38,38,.18);}
    .alert.ok {background:var(--ok-soft);color:var(--ok);border:1px solid rgba(22,163,74,.18);}

    /* â”€â”€ Buttons â”€â”€ */
    .btn{
      width:100%;padding:13px;border:none;border-radius:9px;
      font-size:15px;font-family:inherit;font-weight:600;cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:8px;
      transition:opacity .18s,transform .15s,box-shadow .15s;
      position:relative;overflow:hidden;
    }
    .btn-primary{background:var(--acc-grad);color:#fff;}
    .btn-primary:hover:not(:disabled){opacity:.91;transform:translateY(-1px);box-shadow:0 6px 20px rgba(0,0,0,.16);}
    .btn-primary:disabled{opacity:.42;cursor:not-allowed;transform:none;}
    .spinner{width:17px;height:17px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;flex-shrink:0;}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* â”€â”€ Success â”€â”€ */
    .success-ico{width:68px;height:68px;border-radius:50%;background:var(--ok-soft);border:2px solid rgba(22,163,74,.2);display:flex;align-items:center;justify-content:center;font-size:30px;margin:0 auto 18px;animation:pop .45s cubic-bezier(.22,.68,0,1.3) both;}
    @keyframes pop{from{opacity:0;transform:scale(.3)}to{opacity:1;transform:scale(1)}}
    .success-wrap{text-align:center;padding:8px 0;}

    /* â”€â”€ Footer â”€â”€ */
    .card-footer{margin-top:22px;padding-top:18px;border-top:1px solid var(--border);font-size:12px;color:var(--text-3);text-align:center;line-height:1.6;}
    .card-footer a{color:var(--acc);font-weight:600;text-decoration:none;}
    .card-footer a:hover{text-decoration:underline;}

    /* â”€â”€ Invalid link state â”€â”€ */
    .invalid-wrap{text-align:center;padding:8px 0;}
    .invalid-ico{font-size:40px;margin-bottom:14px;opacity:.6;}
  </style>
</head>
<body>
  <div class="blob blob-1"></div>
  <div class="blob blob-2"></div>

  <div class="card">
    <!-- Brand -->
    <div class="brand">
      <div class="brand-icon">â±ï¸</div>
      <div>
        <div class="brand-name">Focus <strong>Tracker</strong></div>
        <div class="brand-sub">Password reset</div>
      </div>
    </div>

    <!-- â”€â”€ Screen: Reset form â”€â”€ -->
    <div class="screen active" id="scrReset">
      <div class="ttl">Set a new <strong>password</strong></div>
      <p class="desc" id="resetDesc">Choose a strong password for your account.</p>

      <div class="alert" id="resetErr"></div>

      <div class="field">
        <label>New password</label>
        <div class="pw-wrap">
          <input type="password" id="pw1" placeholder="At least 8 characters" autocomplete="new-password" oninput="calcStrength()"/>
          <button class="eye-btn" type="button" onclick="toggleEye('pw1',this)">ğŸ‘</button>
        </div>
        <div class="strength-wrap">
          <div class="bar-track"><div class="bar-fill" id="sBar"></div></div>
          <div class="strength-hint" id="sHint">Enter a password</div>
        </div>
      </div>

      <div class="field">
        <label>Confirm password</label>
        <div class="pw-wrap">
          <input type="password" id="pw2" placeholder="Repeat your password" autocomplete="new-password"/>
          <button class="eye-btn" type="button" onclick="toggleEye('pw2',this)">ğŸ‘</button>
        </div>
      </div>

      <button class="btn btn-primary" id="resetBtn" onclick="doReset()">
        <span>Update password</span>
      </button>
    </div>

    <!-- â”€â”€ Screen: Success â”€â”€ -->
    <div class="screen" id="scrDone">
      <div class="success-wrap">
        <div class="success-ico">âœ…</div>
        <div class="ttl">Password <strong>updated!</strong></div>
        <p class="desc">Your password has been changed successfully. You can now sign in with your new password.</p>
        <button class="btn btn-primary" onclick="goSignIn()"><span>Go Back to Focus Tracker â†’</span></button>
      </div>
    </div>

    <!-- â”€â”€ Screen: Invalid / expired link â”€â”€ -->
    <div class="screen" id="scrInvalid">
      <div class="invalid-wrap">
        <div class="invalid-ico">âš ï¸</div>
        <div class="ttl">Link <strong>expired</strong></div>
        <p class="desc">This password reset link is invalid or has expired. Please request a new one from the extension.</p>
        <button class="btn btn-primary" onclick="goSignIn()"><span>Back to Focus Tracker</span></button>
      </div>
    </div>

    <div class="card-footer">
  Go back to the <a href="#" onclick="window.close()">Focus Tracker Etension</a> to sign in.
</div>
  </div>

  <script>
    // â”€â”€ Apply theme from URL params (?theme=dark&accent=indigo) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // The server embeds these in the email link. Falls back to light/indigo.
    (function(){
      var ACCENTS=['blue','green','purple','red','orange','indigo'];
      var p=new URLSearchParams(location.search);
      var theme=p.get('theme')||'light';
      var accent=p.get('accent')||'indigo';
      var b=document.body;
      b.classList.toggle('dark',theme==='dark');
      ACCENTS.forEach(function(a){b.classList.remove('acc-'+a);});
      b.classList.add('acc-'+(ACCENTS.indexOf(accent)>=0?accent:'indigo'));
    })();

    // â”€â”€ Read OTP + email from URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // The reset email link is:
    //   https://your-server/reset-password.html?otp=123456&email=user@x.com&theme=dark&accent=indigo
    // We read them here so the user NEVER has to type the OTP on this page.
    var _p    = new URLSearchParams(location.search);
    var _otp  = _p.get('otp')   || '';
    var _mail = (_p.get('email') || '').trim().toLowerCase();
    var API   = (typeof API_BASE !== 'undefined' ? API_BASE : null)
                || 'https://habit-tracker-extension.onrender.com';

    // Validate we have what we need
    if (!_otp || !_mail) {
      document.getElementById('scrReset').classList.remove('active');
      document.getElementById('scrInvalid').classList.add('active');
    } else {
      // Show the email in the description
      var descEl = document.getElementById('resetDesc');
      descEl.innerHTML = 'Resetting password for <span class="em">' + _mail + '</span>';
    }

    // â”€â”€ UI helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showAlert(id, msg, type) {
      var el=document.getElementById(id);
      el.textContent=msg;
      el.className='alert show '+(type||'err');
    }
    function hideAlert(id){
      var el=document.getElementById(id);
      el.className='alert';el.textContent='';
    }
    function setLoading(btnId, loading, label) {
      var btn=document.getElementById(btnId);
      btn.disabled=loading;
      btn.innerHTML=loading?'<div class="spinner"></div>':'<span>'+label+'</span>';
    }
    function showScreen(id){
      ['scrReset','scrDone','scrInvalid'].forEach(function(s){
        document.getElementById(s).classList.toggle('active',s===id);
      });
    }

    // â”€â”€ Password strength â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var STRENGTHS=[
      {w:'0%',  bg:'transparent',txt:'Enter a password'},
      {w:'20%', bg:'#ef4444',    txt:'Very weak'},
      {w:'40%', bg:'#f97316',    txt:'Weak'},
      {w:'60%', bg:'#eab308',    txt:'Fair'},
      {w:'80%', bg:'#22c55e',    txt:'Strong'},
      {w:'100%',bg:'#16a34a',    txt:'Very strong ğŸ’ª'},
    ];
    function calcStrength(){
      var pw=document.getElementById('pw1').value;
      var s=0;
      if(pw.length>=8)s++;
      if(pw.length>=12)s++;
      if(/[A-Z]/.test(pw)&&/[a-z]/.test(pw))s++;
      if(/[0-9]/.test(pw))s++;
      if(/[^A-Za-z0-9]/.test(pw))s++;
      var entry=STRENGTHS[Math.min(s,5)];
      var bar=document.getElementById('sBar');
      bar.style.width=entry.w; bar.style.background=entry.bg;
      document.getElementById('sHint').textContent=entry.txt;
    }

    // â”€â”€ Toggle eye â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function toggleEye(inputId, btn){
      var inp=document.getElementById(inputId);
      var isText=inp.type==='text';
      inp.type=isText?'password':'text';
      btn.textContent=isText?'ğŸ‘':'ğŸ™ˆ';
    }

    // â”€â”€ Do reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function doReset(){
      var pw1=document.getElementById('pw1').value;
      var pw2=document.getElementById('pw2').value;
      hideAlert('resetErr');
      document.getElementById('pw1').classList.remove('err-inp');
      document.getElementById('pw2').classList.remove('err-inp');

      if(pw1.length<8||pw1.length>128){
        showAlert('resetErr','Password must be 8â€“128 characters.');
        document.getElementById('pw1').classList.add('err-inp');
        return;
      }
      if(pw1!==pw2){
        showAlert('resetErr','Passwords do not match.');
        document.getElementById('pw2').classList.add('err-inp');
        return;
      }

      setLoading('resetBtn',true,'Update password');
      try{
        var res=await fetch(API+'/auth/reset-password',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({email:_mail,otp:_otp,newPassword:pw1})
        });
        var data=await res.json().catch(function(){return{};});
        if(!res.ok){
          if(res.status===400&&(data.error||'').toLowerCase().includes('expir')){
            showScreen('scrInvalid');return;
          }
          showAlert('resetErr',data.error||'Reset failed. Please try again.');
          return;
        }
        showScreen('scrDone');
      }catch(e){
        showAlert('resetErr','Network error â€” please check your connection.');
      }finally{
        setLoading('resetBtn',false,'Update password');
      }
    }

    // Enter key
    document.addEventListener('keydown',function(e){
      if(e.key!=='Enter')return;
      var s=document.querySelector('.screen.active');
      if(s&&s.id==='scrReset')doReset();
    });

    function goSignIn(){ window.close(); }
  </script>
</body>
</html>